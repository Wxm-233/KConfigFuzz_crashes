R10: ffffffffffffffff R11: 0000000000000246 R12: 0000000000000000
R13: 00007f812d9f5fac R14: 00007f812d9f5fa0 R15: 0000000000000000
 </TASK>
======================================================
WARNING: possible circular locking dependency detected
6.18.0-rc6 #1 Not tainted
------------------------------------------------------
syz.0.17/10944 is trying to acquire lock:
ffff88802518d018 (&ctx->lock){-...}-{2:2}, at: perf_event_context_sched_out kernel/events/core.c:3743 [inline]
ffff88802518d018 (&ctx->lock){-...}-{2:2}, at: __perf_event_task_sched_out+0x432/0x1720 kernel/events/core.c:3848

but task is already holding lock:
ffff88806283a4d8 (&rq->__lock){-.-.}-{2:2}, at: raw_spin_rq_lock_nested+0x2f/0x120 kernel/sched/core.c:638

which lock already depends on the new lock.


the existing dependency chain (in reverse order) is:

-> #5 (&rq->__lock){-.-.}-{2:2}:
       _raw_spin_lock_nested+0x34/0x40 kernel/locking/spinlock.c:378
       raw_spin_rq_lock_nested+0x2f/0x120 kernel/sched/core.c:638
       raw_spin_rq_lock kernel/sched/sched.h:1547 [inline]
       task_rq_lock+0xd3/0x450 kernel/sched/core.c:738
       cgroup_move_task+0x6f/0x260 kernel/sched/psi.c:1170
       css_set_move_task+0x2f8/0x760 kernel/cgroup/cgroup.c:951
       cgroup_post_fork+0x20b/0x9b0 kernel/cgroup/cgroup.c:6913
       copy_process+0x5ad4/0x75d0 kernel/fork.c:2425
       kernel_clone+0xea/0x8b0 kernel/fork.c:2609
       user_mode_thread+0xc8/0x110 kernel/fork.c:2685
       rest_init+0x23/0x2b0 init/main.c:722
       start_kernel+0x3ef/0x4d0 init/main.c:1111
       x86_64_start_reservations+0x18/0x30 arch/x86/kernel/head64.c:310
       x86_64_start_kernel+0x133/0x190 arch/x86/kernel/head64.c:291
       common_startup_64+0x13e/0x148

-> #4 (&p->pi_lock){-.-.}-{2:2}:
       __raw_spin_lock_irqsave include/linux/spinlock_api_smp.h:110 [inline]
       _raw_spin_lock_irqsave+0x3d/0x60 kernel/locking/spinlock.c:162
       class_raw_spinlock_irqsave_constructor include/linux/spinlock.h:557 [inline]
       try_to_wake_up+0xb6/0x1aa0 kernel/sched/core.c:4181
       autoremove_wake_function+0x16/0x150 kernel/sched/wait.c:403
       __wake_up_common+0x138/0x1e0 kernel/sched/wait.c:108
       __wake_up_common_lock kernel/sched/wait.c:125 [inline]
       __wake_up+0x31/0x60 kernel/sched/wait.c:146
       tty_port_default_wakeup+0x47/0x80 drivers/tty/tty_port.c:67
       serial8250_tx_chars+0x6b7/0x8c0 drivers/tty/serial/8250/8250_port.c:1719
       serial8250_handle_irq+0x6b2/0xbe0 drivers/tty/serial/8250/8250_port.c:1827
       serial8250_default_handle_irq+0x9e/0x270 drivers/tty/serial/8250/8250_port.c:1846
       serial8250_interrupt+0xf8/0x1d0 drivers/tty/serial/8250/8250_core.c:82
       __handle_irq_event_percpu+0x237/0x910 kernel/irq/handle.c:203
       handle_irq_event_percpu kernel/irq/handle.c:240 [inline]
       handle_irq_event+0xab/0x1e0 kernel/irq/handle.c:257
       handle_edge_irq+0x3ca/0x9b0 kernel/irq/chip.c:855
       generic_handle_irq_desc include/linux/irqdesc.h:173 [inline]
       handle_irq arch/x86/kernel/irq.c:254 [inline]
       call_irq_handler arch/x86/kernel/irq.c:278 [inline]
       __common_interrupt+0xd1/0x2f0 arch/x86/kernel/irq.c:325
       common_interrupt+0xf0/0x110 arch/x86/kernel/irq.c:318
       asm_common_interrupt+0x26/0x40 arch/x86/include/asm/idtentry.h:688
       native_safe_halt arch/x86/include/asm/irqflags.h:48 [inline]
       pv_native_safe_halt+0x1e/0x30 arch/x86/kernel/paravirt.c:81
       arch_safe_halt arch/x86/include/asm/paravirt.h:107 [inline]
       default_idle+0x1d/0x30 arch/x86/kernel/process.c:767
       default_idle_call+0x6a/0xa0 kernel/sched/idle.c:122
       cpuidle_idle_call kernel/sched/idle.c:190 [inline]
       do_idle+0x36b/0x4c0 kernel/sched/idle.c:330
       cpu_startup_entry+0x4f/0x60 kernel/sched/idle.c:428
       rest_init+0x16b/0x2b0 init/main.c:757
       start_kernel+0x3ef/0x4d0 init/main.c:1111
       x86_64_start_reservations+0x18/0x30 arch/x86/kernel/head64.c:310
       x86_64_start_kernel+0x133/0x190 arch/x86/kernel/head64.c:291
       common_startup_64+0x13e/0x148

-> #3 (&tty->write_wait){-.-.}-{3:3}:
       __raw_spin_lock_irqsave include/linux/spinlock_api_smp.h:110 [inline]
       _raw_spin_lock_irqsave+0x3d/0x60 kernel/locking/spinlock.c:162
       __wake_up_common_lock kernel/sched/wait.c:124 [inline]
       __wake_up+0x1c/0x60 kernel/sched/wait.c:146
       tty_port_default_wakeup+0x47/0x80 drivers/tty/tty_port.c:67
       serial8250_tx_chars+0x6b7/0x8c0 drivers/tty/serial/8250/8250_port.c:1719
       serial8250_handle_irq+0x6b2/0xbe0 drivers/tty/serial/8250/8250_port.c:1827
       serial8250_default_handle_irq+0x9e/0x270 drivers/tty/serial/8250/8250_port.c:1846
       serial8250_interrupt+0xf8/0x1d0 drivers/tty/serial/8250/8250_core.c:82
       __handle_irq_event_percpu+0x237/0x910 kernel/irq/handle.c:203
       handle_irq_event_percpu kernel/irq/handle.c:240 [inline]
       handle_irq_event+0xab/0x1e0 kernel/irq/handle.c:257
       handle_edge_irq+0x3ca/0x9b0 kernel/irq/chip.c:855
       generic_handle_irq_desc include/linux/irqdesc.h:173 [inline]
       handle_irq arch/x86/kernel/irq.c:254 [inline]
       call_irq_handler arch/x86/kernel/irq.c:278 [inline]
       __common_interrupt+0xd1/0x2f0 arch/x86/kernel/irq.c:325
       common_interrupt+0xf0/0x110 arch/x86/kernel/irq.c:318
       asm_common_interrupt+0x26/0x40 arch/x86/include/asm/idtentry.h:688
       native_safe_halt arch/x86/include/asm/irqflags.h:48 [inline]
       pv_native_safe_halt+0x1e/0x30 arch/x86/kernel/paravirt.c:81
       arch_safe_halt arch/x86/include/asm/paravirt.h:107 [inline]
       default_idle+0x1d/0x30 arch/x86/kernel/process.c:767
       default_idle_call+0x6a/0xa0 kernel/sched/idle.c:122
       cpuidle_idle_call kernel/sched/idle.c:190 [inline]
       do_idle+0x36b/0x4c0 kernel/sched/idle.c:330
       cpu_startup_entry+0x4f/0x60 kernel/sched/idle.c:428
       rest_init+0x16b/0x2b0 init/main.c:757
       start_kernel+0x3ef/0x4d0 init/main.c:1111
       x86_64_start_reservations+0x18/0x30 arch/x86/kernel/head64.c:310
       x86_64_start_kernel+0x133/0x190 arch/x86/kernel/head64.c:291
       common_startup_64+0x13e/0x148

-> #2 (&port_lock_key){-.-.}-{3:3}:
       __raw_spin_lock_irqsave include/linux/spinlock_api_smp.h:110 [inline]
       _raw_spin_lock_irqsave+0x3d/0x60 kernel/locking/spinlock.c:162
       uart_port_lock_irqsave include/linux/serial_core.h:717 [inline]
       serial8250_console_write+0x490/0x1890 drivers/tty/serial/8250/8250_port.c:3301
       console_emit_next_record kernel/printk/printk.c:3111 [inline]
       console_flush_all+0x751/0xbd0 kernel/printk/printk.c:3199
       __console_flush_and_unlock kernel/printk/printk.c:3258 [inline]
       console_unlock+0xc2/0x1f0 kernel/printk/printk.c:3298
       vprintk_emit+0x3e7/0x670 kernel/printk/printk.c:2423
       _printk+0xbe/0xf0 kernel/printk/printk.c:2448
       register_console+0xcd4/0x1400 kernel/printk/printk.c:4099
       univ8250_console_init+0x62/0x90 drivers/tty/serial/8250/8250_core.c:511
       console_init+0x163/0x660 kernel/printk/printk.c:4298
       start_kernel+0x298/0x4d0 init/main.c:1048
       x86_64_start_reservations+0x18/0x30 arch/x86/kernel/head64.c:310
       x86_64_start_kernel+0x133/0x190 arch/x86/kernel/head64.c:291
       common_startup_64+0x13e/0x148

-> #1 (console_owner){....}-{0:0}:
       console_lock_spinning_enable+0x72/0x80 kernel/printk/printk.c:1897
       console_emit_next_record kernel/printk/printk.c:3105 [inline]
       console_flush_all+0x6fa/0xbd0 kernel/printk/printk.c:3199
       __console_flush_and_unlock kernel/printk/printk.c:3258 [inline]
       console_unlock+0xc2/0x1f0 kernel/printk/printk.c:3298
       vprintk_emit+0x3e7/0x670 kernel/printk/printk.c:2423
       _printk+0xbe/0xf0 kernel/printk/printk.c:2448
       ex_handler_msr+0x444/0x550 arch/x86/mm/extable.c:170
       fixup_exception+0x119/0xfe0 arch/x86/mm/extable.c:347
       gp_try_fixup_and_notify.constprop.0+0x2e/0x130 arch/x86/kernel/traps.c:766
       __exc_general_protection arch/x86/kernel/traps.c:826 [inline]
       exc_general_protection+0x133/0x320 arch/x86/kernel/traps.c:792
       asm_exc_general_protection+0x26/0x30 arch/x86/include/asm/idtentry.h:612
       __wrmsrq arch/x86/include/asm/msr.h:80 [inline]
       native_write_msr arch/x86/include/asm/msr.h:137 [inline]
       wrmsrq arch/x86/include/asm/msr.h:199 [inline]
       __x86_pmu_enable_event arch/x86/events/perf_event.h:1255 [inline]
       intel_pmu_enable_event+0xab5/0x10c0 arch/x86/events/intel/core.c:2958
       x86_pmu_start+0x1ca/0x270 arch/x86/events/core.c:1536
       x86_pmu_enable+0x57b/0xdb0 arch/x86/events/core.c:1368
       perf_pmu_enable kernel/events/core.c:1255 [inline]
       perf_pmu_enable+0x113/0x160 kernel/events/core.c:1251
       ctx_resched+0x371/0x450 kernel/events/core.c:2936
       __perf_install_in_context+0x48d/0xc10 kernel/events/core.c:3004
       remote_function kernel/events/core.c:93 [inline]
       remote_function+0x128/0x1b0 kernel/events/core.c:73
       csd_do_func kernel/smp.c:136 [inline]
       generic_exec_single+0x1c8/0x380 kernel/smp.c:439
       smp_call_function_single+0x1eb/0x6d0 kernel/smp.c:684
       task_function_call+0xe4/0x170 kernel/events/core.c:121
       perf_install_in_context+0x2ca/0x560 kernel/events/core.c:3107
       __do_sys_perf_event_open+0x19a0/0x2c30 kernel/events/core.c:13745
       do_syscall_x64 arch/x86/entry/syscall_64.c:63 [inline]
       do_syscall_64+0x72/0xfa0 arch/x86/entry/syscall_64.c:94
       entry_SYSCALL_64_after_hwframe+0x76/0x7e

-> #0 (&ctx->lock){-...}-{2:2}:
       check_prev_add kernel/locking/lockdep.c:3165 [inline]
       check_prevs_add kernel/locking/lockdep.c:3284 [inline]
       validate_chain kernel/locking/lockdep.c:3908 [inline]
       __lock_acquire+0x1653/0x2760 kernel/locking/lockdep.c:5237
       lock_acquire kernel/locking/lockdep.c:5868 [inline]
       lock_acquire+0x17b/0x340 kernel/locking/lockdep.c:5825
       __raw_spin_lock include/linux/spinlock_api_smp.h:133 [inline]
       _raw_spin_lock+0x2e/0x40 kernel/locking/spinlock.c:154
       perf_event_context_sched_out kernel/events/core.c:3743 [inline]
       __perf_event_task_sched_out+0x432/0x1720 kernel/events/core.c:3848
       perf_event_task_sched_out include/linux/perf_event.h:1654 [inline]
       prepare_task_switch kernel/sched/core.c:5123 [inline]
       context_switch kernel/sched/core.c:5272 [inline]
       __schedule+0x21bf/0x5b70 kernel/sched/core.c:6929
       preempt_schedule_common+0x44/0xb0 kernel/sched/core.c:7113
       preempt_schedule_thunk+0x16/0x30 arch/x86/entry/thunk.S:12
       smp_call_function_single+0x619/0x6d0 kernel/smp.c:689
       task_function_call+0xe4/0x170 kernel/events/core.c:121
       perf_install_in_context+0x2ca/0x560 kernel/events/core.c:3107
       __do_sys_perf_event_open+0x19a0/0x2c30 kernel/events/core.c:13745
       do_syscall_x64 arch/x86/entry/syscall_64.c:63 [inline]
       do_syscall_64+0x72/0xfa0 arch/x86/entry/syscall_64.c:94
       entry_SYSCALL_64_after_hwframe+0x76/0x7e

other info that might help us debug this:

Chain exists of:
  &ctx->lock --> &p->pi_lock --> &rq->__lock

 Possible unsafe locking scenario:

       CPU0                    CPU1
       ----                    ----
  lock(&rq->__lock);
                               lock(&p->pi_lock);
                               lock(&rq->__lock);
  lock(&ctx->lock);

 *** DEADLOCK ***

4 locks held by syz.0.17/10944:
 #0: ffffffff9a60dcd0 (&pmus_srcu){.+.+}-{0:0}, at: srcu_lock_acquire include/linux/srcu.h:161 [inline]
 #0: ffffffff9a60dcd0 (&pmus_srcu){.+.+}-{0:0}, at: srcu_read_lock include/linux/srcu.h:253 [inline]
 #0: ffffffff9a60dcd0 (&pmus_srcu){.+.+}-{0:0}, at: class_srcu_constructor include/linux/srcu.h:508 [inline]
 #0: ffffffff9a60dcd0 (&pmus_srcu){.+.+}-{0:0}, at: __do_sys_perf_event_open+0x332/0x2c30 kernel/events/core.c:13470
 #1: ffff88802b3731f8 (&sig->exec_update_lock){++++}-{4:4}, at: __do_sys_perf_event_open+0x8d3/0x2c30 kernel/events/core.c:13536
 #2: ffff88802518d0a8 (&ctx->mutex){+.+.}-{4:4}, at: __do_sys_perf_event_open+0xa47/0x2c30 kernel/events/core.c:13560
 #3: ffff88806283a4d8 (&rq->__lock){-.-.}-{2:2}, at: raw_spin_rq_lock_nested+0x2f/0x120 kernel/sched/core.c:638

stack backtrace:
CPU: 0 UID: 0 PID: 10944 Comm: syz.0.17 Not tainted 6.18.0-rc6 #1 PREEMPT(full) 
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.15.0-1 04/01/2014
Call Trace:
 <TASK>
 __dump_stack lib/dump_stack.c:94 [inline]
 dump_stack_lvl+0x116/0x1b0 lib/dump_stack.c:120
 print_circular_bug+0x274/0x340 kernel/locking/lockdep.c:2043
 check_noncircular+0x12f/0x150 kernel/locking/lockdep.c:2175
 check_prev_add kernel/locking/lockdep.c:3165 [inline]
 check_prevs_add kernel/locking/lockdep.c:3284 [inline]
 validate_chain kernel/locking/lockdep.c:3908 [inline]
 __lock_acquire+0x1653/0x2760 kernel/locking/lockdep.c:5237
 lock_acquire kernel/locking/lockdep.c:5868 [inline]
 lock_acquire+0x17b/0x340 kernel/locking/lockdep.c:5825
 __raw_spin_lock include/linux/spinlock_api_smp.h:133 [inline]
 _raw_spin_lock+0x2e/0x40 kernel/locking/spinlock.c:154
 perf_event_context_sched_out kernel/events/core.c:3743 [inline]
 __perf_event_task_sched_out+0x432/0x1720 kernel/events/core.c:3848
 perf_event_task_sched_out include/linux/perf_event.h:1654 [inline]
 prepare_task_switch kernel/sched/core.c:5123 [inline]
 context_switch kernel/sched/core.c:5272 [inline]
 __schedule+0x21bf/0x5b70 kernel/sched/core.c:6929
 preempt_schedule_common+0x44/0xb0 kernel/sched/core.c:7113
 preempt_schedule_thunk+0x16/0x30 arch/x86/entry/thunk.S:12
 smp_call_function_single+0x619/0x6d0 kernel/smp.c:689
 task_function_call+0xe4/0x170 kernel/events/core.c:121
 perf_install_in_context+0x2ca/0x560 kernel/events/core.c:3107
 __do_sys_perf_event_open+0x19a0/0x2c30 kernel/events/core.c:13745
 do_syscall_x64 arch/x86/entry/syscall_64.c:63 [inline]
 do_syscall_64+0x72/0xfa0 arch/x86/entry/syscall_64.c:94
 entry_SYSCALL_64_after_hwframe+0x76/0x7e
RIP: 0033:0x7f812d7ae16d
Code: 02 b8 ff ff ff ff c3 66 0f 1f 44 00 00 f3 0f 1e fa 48 89 f8 48 89 f7 48 89 d6 48 89 ca 4d 89 c2 4d 89 c8 4c 8b 4c 24 08 0f 05 <48> 3d 01 f0 ff ff 73 01 c3 48 c7 c1 a8 ff ff ff f7 d8 64 89 01 48
RSP: 002b:00007ffccd6352f8 EFLAGS: 00000246 ORIG_RAX: 000000000000012a
RAX: ffffffffffffffda RBX: 00007f812d9f5fa0 RCX: 00007f812d7ae16d
RDX: ffffffffffffffff RSI: 0000000000000000 RDI: 0000200000000dc0
RBP: 00007f812d8480f0 R08: 0000000000000008 R09: 0000000000000000
R10: ffffffffffffffff R11: 0000000000000246 R12: 0000000000000000
R13: 00007f812d9f5fac R14: 00007f812d9f5fa0 R15: 0000000000000000
 </TASK>
